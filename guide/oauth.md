This is an overview of how to get access to the Amiqus API using the OAuth 2.0 flow.

## Register your application
In order to communicate with the Amiqus API using OAuth 2.0 you need an Amiqus account to register your application. If you don't yet have one, [contact us](mailto:sales@amiqus.co) to set up a sandbox Amiqus account.

You can register your application by:
1. Visiting the Developer Settings dashboard
2. Click API Clients;
3. Click Register your application; and
4. Enter the following information:

- The name of your application (this will be shown to users on the authorisation page, so it should be easily recognisable)
- The URL(s) of your application where users are redirected after authorisation is complete. You can add or update redirect URLs at any time.

Once your application is registered you will be issued with a **Client ID** and a **Client secret**, which will be required to create access tokens.

[@todo: Include example screenshot/video of what this looks like to the user]

## Authorisation 

The OAuth 2.0 flow is comprised of the following steps: 

1. The user is redirected from your app to Amiqus;
2. The user grants your app access to their Amiqus account;
3. The user is redirected back to your app with an **authorisation code**;
4. Your app makes a request to the Amiqus API exchanging the **authorisation code** for an **access token**; 
5. Your app can now use the **access token** to perform requests to the Amiqus API.

This flow should be unobstructive to the user's experience.

[@todo: Include example screenshot/video of what the whole flow looks like]

### User authentication and authorisation code 

You will need to direct the user to the authorisation page using the **GET** request outlined below. Before the user is sent to this page, they will be invited to log in (if they have not already). 

```
https://id.amiqus.co/oauth/authorize?client_id={{client_id}}&redirect_uri={{redirect_uri}}&state={{state}}&response_type=code
```
This request contains **two required** and one optional query string parameters as defined below:  
| Query string parameter  | description  |
| :------ | :---- |
|`client_id`| Your Client ID issued when your application has been registered. |   
|`redirect_uri`| This is the URL of your app that users are redirected to after they have granted (or denied) access to Amiqus. **This must match the URL linked to the registered app.** The URL must be url-encoded. |  
|`state`| (Optional) A value generated by your application that is returned along with the authorisation code to ensure the integrity of the request. This can be random or include metadata (e.g. base64 encoded JSON), but **must not** contain sensitive information. | 

[@todo: Include example screenshot of what this looks like to the user]

Once the user has granted or denied authorisation, they are redirected to the URL provided in the request, along with the query string parameters `code` and, if provided `state`. If authorisation is denied, the query string parameter `error=access_denied` is returned instead of `code`. In this event, you will need to re-start the authorisation process.

 > ⚠️ Authorisation Code Lifetime
 > 
 > Authorisation codes are valid for **10 minutes** and can only be redeemed once.

### Requesting an access token
Now that you have your authorisation code, you can exchange this for an access token. To do this, you should make a **POST** request to `https://id.amiqus.co/oauth/token` and include the following payload:

| Parameter  | value required  |
| :------ | :---- |
|`grant_type`| `authorization_code` |  
|`client_id`| Your Client ID issued when your app was registered |
|`client_secret`| Your Client secret issued when your application was registered |
|`code` | The authorisation code generated from the authorisation step |
|`redirect_uri`| The redirect URL your registered with your application |

Here is a cURL example below:

```
curl -X POST \
  https://id.amiqus.co/oauth/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d
'grant_type=authorization_code&client_id=1&client_secret=tA4VDhreEYGrlQGBbau2dbr2
HNGzd35PBvfQELBi&code=def502006d662b37f1a8226d9cedf46c8b6a93cc1031836136c634fcfa3
3a3d6a81dc7d46b062c8a43806ab9fccb676a4e447833bb2b3fb4d4e9f178f912caa679fa0c2e08bd
84e3067f160bf8f94136dad7b5682389252349fa644261592d7808b8936acbc214ef8980ab69601b2
c9f911bde303efaff6db8366c7fed6bd51ec2cd8fb2cc584e8407806b114e60c6e8905eb5e17b0c5b
240b3022e153844707a8a0d5b65162e2be64cc868850ef598cf0229aa3886f5508a5fad7834e2ebb8
9e59eaa49584967ed0d676263dfaa583f8d3c3b682f5ded7ceece83b74c626f84b78579c19d14a7ce
d3ad4abe6a4d0be9065b5bf93e02bffd7cb5c920fda475b2a716627aa3eec66c57bf7161ee9f178ea
ff90b7e99111e5d4241c73ea9836985cb8bfe523196f2c19fea7b19c29b333b7f0d3ba47d5df636df
4e3ad16924445f17a5c74afa33d67f3933b4c448b34b1380ee32a75044318060846b676fe8796a6bc
00892124e&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback'

```
If your API request is successful you will recieve an **access token** in the response. The response will also contain the lifespan of the access token in seconds and a refresh token that can be used to generate a new access token (see **Refreshing a token** below). 

Example response:

```
{
    "token_type": "Bearer",
    "expires_in": 31536000,
    "access_token":
"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6Ijg5OWZhNGQwZjNiYjk1MzMxYzk2ZDczMzI5
ZTZkMDBkYjY5ZGM0MDBjYzIwMDJjYWEyODAwYjg3MDRjNGQ4MTQ2ODAyOTc1MTgxMzI4NzA3In0.eyJhd
WQiOiIxIiwianRpIjoiODk5ZmE0ZDBmM2JiOTUzMzFjOTZkNzMzMjllNmQwMGRiNjlkYzQwMGNjMjAwMm
NhYTI4MDBiODcwNGM0ZDgxNDY4MDI5NzUxODEzMjg3MDciLCJpYXQiOjE1MzU0NjUwNjUsIm5iZiI6MTU
zNTQ2NTA2NSwiZXhwIjoxNTY3MDAxMDY1LCJzdWIiOiIzOjE1MzU0NjE0ODQiLCJzY29wZXMiOltdfQ.O
fTGbA0MWvb-at2vMECUPMATJPNkJ85B5aVUrdkDOCo1cYYOMwDuvwsWU3sKwQAKvgO6K9c11zgDqIPovu
gZ3KgMEtzUnmz7DRZN48ctXw8BvCCkqx3i_AK6kJZWG4uGS7Y_z3bRbHizKSjYGKhvNKsJ5-2p9y2JiQH
BNHp37wZg9RR74no21YjxRtXkJ62NpqU_rxkR78so5LXFPoaFvEXavD1vtyO8W3ThEMOpxHrZJt0zUahU
BsXuxcXcUUTM0d8mwzo8zxGokt-oywNNtiRC2KcTZhJ0TYPw2YI3ZGe6PhMVqi0rNqvlx_oJzPPhfBMf-
o8jaM5HE5_p41_fc9g-JqFcvpBxtvReiOESqOqBXUGifn6YlwjAUMy1rtzWhyJk7rZNgj92k1vUR3",
    "refresh_token":
"def50200ad0898fec07a14dd0f7b7dd90fb49f87b5053964274387c24daf57f7d454560b88b759e6
bd2d4b1c8ab12413d026657d7a476684d41d6b44154101babbd5f633d9170b2460040f154bdc5347b
8cf62d688b47b7ab90c3d1fb932da799b3347a4b876d88e8cf5b8c6539d66f1bd756dbcb5c4367dde
0478eb195deb089a16c14bcac2ab5edf9d49d4b8a31eef260773d4df864d803753b006e1e9c466755
507c7c702ec0d2a6b9e13f1b228184fc54522e8f6aebf7b7febf723dd3ebf44c3b7422e0ab9bfd09f
07471fe8c70a7e252066856af2a4120c39b855cce6847bc8e13003a4ef59b4d78cad0d36c4925e639
bcc8b090809cd5a31088e826c8e539"
}
```
Remember to store both the `access_token` and `refresh_token` values safely as these are essential for your use of the Amiqus API. 

### Refreshing an access token
Now that you have an access token you can use the refresh token also provided in the response at any point to refresh your access token before it expires. By refreshing your access tokens, you can programmatically prevent them from expiring, without the need to repeat the authorisation flow. Each refresh token can only be used once. 

To refresh your access token, you should make a **POST** request to `https://id.amiqus.co/oauth/token` and included the following payload:

| Parameter  | value required  |
| :------ | :---- |
|`grant_type`| `refresh_token` |  
|`client_id`| Your Client ID issued when your app was registered |
|`client_secret`| Your Client secret issued when your application was registered|
|`refresh_token` | The refresh token that was provided in the **Requesting a token** response |
|`redirect_uri`| The redirect URL your registered with your application|

Here is a cURL example below:

```
curl -X POST \
  https://id.amiqus.co/oauth/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d
'grant_type=refresh_token&client_id=1&client_secret=tA4VDhreEYGrlQGBbau2dbr2HNGzd
35PBvfQELBi&refresh_token=def50200ad0898fec07a14dd0f7b7dd90fb49f87b5053964274387c
24daf57f7d454560b88b759e6bd2d4b1c8ab12413d026657d7a476684d41d6b44154101babbd5f633
d9170b2460040f154bdc5347b8cf62d688b47b7ab90c3d1fb932da799b3347a4b876d88e8cf5b8c65
39d66f1bd756dbcb5c4367dde0478eb195deb089a16c14bcac2ab5edf9d49d4b8a31eef260773d4df
864d803753b006e1e9c466755507c7c702ec0d2a6b9e13f1b228184fc54522e8f6aebf7b7febf723d
d3ebf44c3b7422e0ab9bfd09f07471fe8c70a7e252066856af2a4120c39b855cce6847bc8e13003a4
ef59b4d78cad0d36c4925e639bcc8b090809cd5a31088e826c8e539&redirect_uri=https%3A%2F%
2Fexample.com%2Fcallback'
```

The response will be the same as when you requested an access token with the authorisation code above. 

 > ⚠️ Access token replacement
 > 
 > The refresh token and the original access token are invalidated immediately after a successful response.

### Revoking a token
Users may revoke access at any time by visiting the Team apps page in Workflow Integrations. If this is the case, the user must go through the authorisation flow again before a new access token can be requested. 

### Using the API with your access token
Now that you have a access token you can start using the Amiqus API. 

You must ensure that you always use the following header with any request:

| Header  | value required  |
| :------ | :---- |
|`Authorization`| `Bearer {{token}}`|

`{{token}}` will be the value of the access token generated. Here is a cURL example: 

```
curl -X GET \
  https://id.amiqus.co/api/v2/me \
  -H 'Authorization: Bearer
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6Ijg5OWZhNGQwZjNiYjk1MzMxYzk2ZDczMzI5Z
TZkMDBkYjY5ZGM0MDBjYzIwMDJjYWEyODAwYjg3MDRjNGQ4MTQ2ODAyOTc1MTgxMzI4NzA3In0.eyJhdW
QiOiIxIiwianRpIjoiODk5ZmE0ZDBmM2JiOTUzMzFjOTZkNzMzMjllNmQwMGRiNjlkYzQwMGNjMjAwMmN
hYTI4MDBiODcwNGM0ZDgxNDY4MDI5NzUxODEzMjg3MDciLCJpYXQiOjE1MzU0NjUwNjUsIm5iZiI6MTUz
NTQ2NTA2NSwiZXhwIjoxNTY3MDAxMDY1LCJzdWIiOiIzOjE1MzU0NjE0ODQiLCJzY29wZXMiOltdfQ.Of
TGbA0MWvb-at2vMECUPMATJPNkJ85B5aVUrdkDOCo1cYYOMwDuvwsWU3sKwQAKvgO6K9c11zgDqIPovug
Z3KgMEtzUnmz7DRZN48ctXw8BvCCkqx3i_AK6kJZWG4uGS7Y_z3bRbHizKSjYGKhvNKsJ5-2p9y2JiQHB
NHp37wZg9RR74no21YjxRtXkJ62NpqU_rxkR78so5LXFPoaFvEXavD1vtyO8W3ThEMOpxHrZJt0zUahUB
sXuxcXcUUTM0d8mwzo8zxGokt-oywNNtiRC2KcTZhJ0TYPw2YI3ZGe6PhMVqi0rNqvlx_oJzPPhfBMf-o
8jaM5HE5_p41_fc9g-JqFcvpBxtvReiOESqOqBXUGifn6YlwjAUMy1rtzWhyJk7rZNgj92k1vUR3'
```
